!function(){function i(){}function t(t){this.converter=t.converter,this.data=t.path||t.data,this.imageData=[],this.multiplier=t.multiplier||1,this.padding=t.padding||0,this.fps=t.fps||25,this.stepsPerFrame=~~t.stepsPerFrame||1,this.trailLength=t.trailLength||1,this.pointDistance=t.pointDistance||.05,this.domClass=t.domClass||"sonic",this.backgroundColor=t.backgroundColor||"rgba(0,0,0,0)",this.fillColor=t.fillColor,this.strokeColor=t.strokeColor,this.stepMethod="string"==typeof t.step?s[t.step]:t.step||s.square,this._setup=t.setup||i,this._teardown=t.teardown||i,this._preStep=t.preStep||i,this.pixelRatio=t.pixelRatio||null,this.width=t.width,this.height=t.height,this.fullWidth=this.width+2*this.padding,this.fullHeight=this.height+2*this.padding,this.domClass=t.domClass||"sonic",this.style=t.style||{},this.setup()}var f=t.argTypes={DIM:1,DEGREE:2,RADIUS:3,OTHER:0},d=t.argSignatures={arc:[1,1,3,2,2,0],bezier:[1,1,1,1,1,1,1,1],line:[1,1,1,1]},g=t.pathMethods={bezier:function(t,i,s,e,h,a,l,r,o){var n=1-(t=1-t),p=t*t,c=n*n,u=p*t,p=3*p*n,t=3*t*c,c=c*n;return[u*i+p*a+t*r+c*e,u*s+p*l+t*o+c*h]},arc:function(t,i,s,e,h,a){a=(a-h)*t+h,h=[Math.cos(a)*e+i,Math.sin(a)*e+s];return h.angle=a,h.t=t,h},line:function(t,i,s,e,h){return[(e-i)*t+i,(h-s)*t+s]}},s=t.stepMethods={square:function(t,i,s,e,h){this._.fillRect(t.x-3,t.y-3,6,6)},fader:function(t,i,s,e,h){this._.beginPath(),this._last&&this._.moveTo(this._last.x,this._last.y),this._.lineTo(t.x,t.y),this._.closePath(),this._.stroke(),this._last=t}};t.prototype={calculatePixelRatio:function(){return(window.devicePixelRatio||1)/(this._.webkitBackingStorePixelRatio||this._.mozBackingStorePixelRatio||this._.msBackingStorePixelRatio||this._.oBackingStorePixelRatio||this._.backingStorePixelRatio||1)},setup:function(){var t,i,s,e,h,a=this.data;for(h in this.canvas=document.createElement("canvas"),this.style)this.canvas.style[h]=this.style[h];this._=this.canvas.getContext("2d"),null==this.pixelRatio&&(this.pixelRatio=this.calculatePixelRatio()),this.canvas.className=this.domClass,1!==this.pixelRatio?(this.canvas.style.height=this.fullHeight+"px",this.canvas.style.width=this.fullWidth+"px",this.fullHeight*=this.pixelRatio,this.fullWidth*=this.pixelRatio,this.canvas.height=this.fullHeight,this.canvas.width=this.fullWidth,this._.scale(this.pixelRatio,this.pixelRatio)):(this.canvas.height=this.fullHeight,this.canvas.width=this.fullWidth),this.points=[];for(var l=-1,r=a.length;++l<r;){if(t=a[l].slice(1),(s=a[l][0])in d)for(var o=-1,n=t.length;++o<n;){switch(i=d[s][o],e=t[o],i){case f.RADIUS:e*=this.multiplier;break;case f.DIM:e=(e*=this.multiplier)+this.padding;break;case f.DEGREE:e*=Math.PI/180}t[o]=e}t.unshift(0);for(var p,c=this.pointDistance,u=c;u<=1;u+=c)u=Math.round(+u/c)/(1/c),t[0]=u,p=g[s].apply(null,t),this.points.push({x:p[0],y:p[1],progress:u})}this.frame=0,this.converter&&this.converter.setup&&this.converter.setup(this)},prep:function(t){if(!(t in this.imageData)){this._.clearRect(0,0,this.fullWidth,this.fullHeight),this._.fillStyle=this.backgroundColor,this._.fillRect(0,0,this.fullWidth,this.fullHeight);var i=this.points,s=i.length;this.pointDistance;this._setup();for(var e,h,a,l=-1,r=s*this.trailLength;++l<r&&!this.stopped;)(a=i[a=t+l]||i[a-s])&&(this.alpha=Math.round(l/(r-1)*1e3)/1e3,this._.globalAlpha=this.alpha,this.fillColor&&(this._.fillStyle=this.fillColor),this.strokeColor&&(this._.strokeStyle=this.strokeColor),e=t/(this.points.length-1),this._preStep(a,h=l/(r-1),e),this.stepMethod(a,h,e));return this._teardown(),!0}},draw:function(){this.prep(this.frame)||(this._.clearRect(0,0,this.fullWidth,this.fullWidth),this._.putImageData(this.imageData[this.frame],0,0)),this.converter&&this.converter.step&&this.converter.step(this),this.iterateFrame()||this.converter&&this.converter.teardown&&(this.converter.teardown(this),this.converter=null)},iterateFrame:function(){return this.frame+=this.stepsPerFrame,!(this.frame>=this.points.length)||(this.frame=0,!1)},play:function(){this.stopped=!1;var t=this;this.timer=setInterval(function(){t.draw()},1e3/this.fps)},stop:function(){this.stopped=!0,this.timer&&clearInterval(this.timer)}},window.Sonic=t}();

let sc=window.sc||{};class Render{constructor(){this.data=null}setData(t){this.data=t}drawLine(t,e,n,r,u){t.beginPath(),t.moveTo(e,r),t.lineTo(n,u),t.stroke(),t.closePath()}floor(t,e){var n=Math.pow(10,e);return(Math.floor(t*n)/n).toFixed(e)}formateValue(t,e=2){var n;return 0===t?0:1e6<t?100<(n=t/1e6)?this.floor(n,e-2)+"M":this.floor(n,e-1)+"M":1e3<t?100<(n=t/1e3)?this.floor(n,e-1)+"K":this.floor(n,e-2)+"K":100<t?this.floor(t,e-1):this.floor(t,e)}formate(t,e){function n(t,e){return(t+="").length<e?new Array(++e-t.length).join("0")+t:t}let r=e?new Date(1e3*e):new Date,u=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],o={1:"st",2:"nd",3:"rd",21:"st",22:"nd",23:"rd",31:"st"},a=["","January","February","March","April","May","June","July","August","September","October","November","December"],i={d:function(){return n(i.j(),2)},D:function(){return i.l().substr(0,3)},j:function(){return r.getDate()},l:function(){return u[i.w()]},N:function(){return i.w()+1},S:function(){return o[i.j()]?o[i.j()]:"th"},w:function(){return r.getDay()},z:function(){return(r-new Date(r.getFullYear()+"/1/1"))/864e5>>0},W:function(){var t=i.z(),e=364+i.L()-t,n=(new Date(r.getFullYear()+"/1/1").getDay()||7)-1;return e<=2&&(r.getDay()||7)-1<=2-e?1:t<=2&&4<=n&&6-n<=t?(e=new Date(r.getFullYear()-1+"/12/31"),date("W",Math.round(e.getTime()/1e3))):1+(n<=3?(t+n)/7:(t-(7-n))/7)>>0},F:function(){return a[i.n()]},m:function(){return n(i.n(),2)},M:function(){return i.F().substr(0,3)},n:function(){return r.getMonth()+1},t:function(){var t;return 2==(t=r.getMonth()+1)?28+i.L():1&t&&t<8||!(1&t)&&7<t?31:30},L:function(){var t=i.Y();return 3&t||!(t%100)&&t%400?0:1},Y:function(){return r.getFullYear()},y:function(){return(r.getFullYear()+"").slice(2)},a:function(){return 11<r.getHours()?"pm":"am"},A:function(){return i.a().toUpperCase()},B:function(){var t=60*(r.getTimezoneOffset()+60),t=3600*r.getHours()+60*r.getMinutes()+r.getSeconds()+t;let e=Math.floor(t/86.4);return 1e3<e&&(e-=1e3),e<0&&(e+=1e3),1===String(e).length&&(e="00"+e),e=2===String(e).length?"0"+e:e},g:function(){return r.getHours()%12||12},G:function(){return r.getHours()},h:function(){return n(i.g(),2)},H:function(){return n(r.getHours(),2)},i:function(){return n(r.getMinutes(),2)},s:function(){return n(r.getSeconds(),2)},O:function(){var t=n(Math.abs(r.getTimezoneOffset()/60*100),4);return t=0<r.getTimezoneOffset()?"-"+t:"+"+t},P:function(){var t=i.O();return t.substr(0,3)+":"+t.substr(3,2)},c:function(){return i.Y()+"-"+i.m()+"-"+i.d()+"T"+i.h()+":"+i.i()+":"+i.s()+i.P()},U:function(){return Math.round(r.getTime()/1e3)}};return t.replace(/([a-zA-Z])/g,function(t,e){let n="";return n=t==e&&i[e]?i[e]():e})}fetch(t,e){let n=new XMLHttpRequest;n.onload=function(){var t;200===n.status&&0===(t=JSON.parse(n.responseText)).code&&t.data?e&&e(t.data):e&&e(!1)},n.addEventListener("error",function(t){e&&e(!1)},!1),n.open("GET",t,!0),n.withCredentials=!0,n.send(null)}createDom(){let t=document.createElement("canvas");return t.width=this.width,t.height=this.height,t.style.width=.5*t.width+"px",t.style.height=.5*t.height+"px",t.style.position="absolute",t.style.left=0,t.style.top=0,t}query(e){return"?"+Object.keys(e).map(t=>encodeURIComponent(t)+"="+encodeURIComponent(e[t])).join("&")}}
class ChartGraph extends Render{constructor(t){var i;super(),t.el&&t.url&&(this.chartType=ChartGraph.ChartType.candle,this.maxBarNum=60,this.minBarNum=25,this.options=Object.assign({el:"",url:"",updateInterval:1500,request:{time:0,channel:"",period:1440,limit:"1500"},cache:!0,background:[{y0:0,y1:560,backgroundColor:"#101a27"},{y0:560,backgroundColor:"#131e2d"}],barNum:45,candle:{top:80,height:480,highColor:"#03ad8f",lowColor:"#d04b64",MA:[{ma:5,color:"#ffb1a0"},{ma:10,color:"#ff7bde"},{ma:30,color:"#6185ff"}]},bar:{top:620,height:50,highColor:"#03ad8f",lowColor:"#d04b64",yAxis:{fontSize:"20px",offset:500},MA:[{ma:5,color:"#ffb1a0"},{ma:30,color:"#6185ff"}]},xAxis:{offset:25,width:1,color:"#fff",position:"bottom",show:!1,mark:{lineWidth:1,lineColor:"#fff",textColor:"#fff",fontSize:"20px",lineHeight:5,show:!0}},yAxis:{offset:0,width:1,color:"#fff",position:"right",show:!1,mark:{lineWidth:1,lineColor:"#fff",textColor:"#fff",fontSize:"20px",lineHeight:5,show:!0}}},t),this.url=this.options.url,this.request=this.options.request,this.el=this.options.el,this.el.style.position="relative",this.updateTimerHandler=null,this.width=this.el.style.width||this.el.clientWidth,this.height=this.el.style.height?this.el.style.width:this.el.clientHeight,this.width*=2,this.height*=2,this.calculateBarNum(this.options.barNum),this.canvas=this.createDom(),this.ctx=this.canvas.getContext("2d"),this.ctx.translate(.5,.5),this.el.appendChild(this.canvas),this.aniCanvas=this.createDom(),this.aniCtx=this.aniCanvas.getContext("2d"),this.aniCtx.translate(.5,.5),this.el.appendChild(this.aniCanvas),this.topCanvas=this.createDom(),this.topCtx=this.topCanvas.getContext("2d"),this.topCtx.translate(.5,.5),this.el.appendChild(this.topCanvas),this.axis=new RenderAxis,this.candle=new RenderCandle,this.candleMA=new RenderCandleMA,this.bar=new RenderBar,this.barMA=new RenderBarMA,this.last=new RenderLast,this.time=new RenderTime,this.showCandleMA=!0,this.showBarMA=!0,this.priceFixed=5,this.ctx.fillStyle="#101a27",this.ctx.fillRect(0,0,this.width,this.height),this.lastBarItem=null,this.fetchData(),this.initEvent(),this.curSelectIndex=null,this.moveDis=0,this.minMoveDis=3,this.moveSpeed=3,this.stepDis=0,t=this.options.locale||"zh-cn",this.locale=(i={"zh-cn":{date:"时间",open:"开",close:"收",high:"高",low:"低",change:"涨跌额",changer:"涨跌幅",executed:"成交量"},en:{date:"Date",open:"Open",close:"Close",high:"H",low:"L",change:"Change",changer:"Change%",executed:"Executed"}})[t]||i.en)}calculateBarNum(t){return(t=t<this.minBarNum?this.minBarNum:t)>this.maxBarNum&&(t=this.maxBarNum),this.barNum!==t&&(this.barNum=t,this.barSpacing=(this.width-2*this.options.yAxis.offset)/this.barNum,this.leftBlank=parseInt((.2*this.width/this.barSpacing).toString()),!0)}select(t){t=parseInt(t/this.barSpacing*2);this.curSelectIndex!==this.visibleRange.from+t&&(this.curSelectIndex=this.visibleRange.from+t,this.curSelectIndex>=this.data.bars.length||this.drawTipWindow(this.curSelectIndex,t))}selectIndex(t){this.data&&(this.curSelectIndex=t,t=this.visibleRange.from-this.curSelectIndex,this.curSelectIndex>=this.data.bars.length||this.drawTipWindow(this.curSelectIndex,t))}drawTipWindow(s,h){this.curSelectIndex=s,this.topCtx.clearRect(0,0,this.width,this.height);s=this.data.bars[this.curSelectIndex];if(s){var a=(h+.5)*this.barSpacing;let t=this.topCtx.createLinearGradient(0,0,0,this.height);t.addColorStop(0,"transparent"),t.addColorStop(.4,"rgba(204,204,204,0.4)"),t.addColorStop(.7,"rgba(204,204,204,0.4)"),t.addColorStop(1,"transparent"),this.topCtx.fillStyle=t,this.topCtx.fillRect(a-.5*this.barSpacing,0,this.barSpacing,this.height);var l=this.options.candle.height/(this.yRange.max-this.yRange.min);let i;i=(this.chartType,ChartGraph.ChartType.time,this.options.candle.height+this.options.candle.top-(s.close-this.yRange.min)*l);l=280;let e=0;e=a<.5*this.width?(this.topCtx.lineWidth=1,this.topCtx.strokeStyle="#fff",this.drawLine(this.topCtx,112,this.width,i,i),this.topCtx.strokeStyle="#fff",this.topCtx.lineWidth=2,this.topCtx.beginPath(),this.topCtx.moveTo(2,i+20),this.topCtx.lineTo(92,i+20),this.topCtx.lineTo(112,i),this.topCtx.lineTo(92,i-20),this.topCtx.lineTo(2,i-20),this.topCtx.lineTo(2,i+20),this.topCtx.stroke(),this.topCtx.fillStyle="#181728",this.topCtx.fill(),this.topCtx.closePath(),this.topCtx.fillStyle="#fff",this.topCtx.font="20px Arial",this.topCtx.textAlign="center",this.topCtx.fillText(s.close,52,i+6,100),this.width-l):(this.topCtx.lineWidth=1,this.topCtx.strokeStyle="#fff",this.drawLine(this.topCtx,0,this.width-112,i,i),this.topCtx.beginPath(),this.topCtx.moveTo(this.width-112,i),this.topCtx.lineTo(this.width-92,i+20),this.topCtx.lineTo(this.width-2,i+20),this.topCtx.lineTo(this.width-2,i-20),this.topCtx.lineTo(this.width-92,i-20),this.topCtx.lineTo(this.width-112,i),this.topCtx.stroke(),this.topCtx.fillStyle="#161f2e",this.topCtx.fill(),this.topCtx.closePath(),this.topCtx.fillStyle="#fff",this.topCtx.font="20px Arial",this.topCtx.textAlign="center",this.topCtx.fillText(s.close,this.width-55,i+8,100),2);var o=this.formate(this.xFormat,s.time);if(this.chartType===ChartGraph.ChartType.candle){var n=this.options.candle.top-10,r=(this.topCtx.strokeStyle="#fff",this.topCtx.lineWidth=2,this.topCtx.beginPath(),this.topCtx.moveTo(e,n),this.topCtx.lineTo(e+l-2,n),this.topCtx.lineTo(e+l-2,280+n),this.topCtx.lineTo(e,280+n),this.topCtx.lineTo(e,n),this.topCtx.stroke(),this.topCtx.fillStyle="#161f2e",this.topCtx.fill(),this.topCtx.closePath(),this.topCtx.fillStyle="#fff",this.topCtx.font="20px Arial",this.topCtx.textAlign="left",parseInt(84)),p=parseInt(168),d=parseInt(e+10),r=(this.topCtx.fillText(this.locale.date,d,parseInt(17+n+10),r),this.topCtx.fillText(this.locale.open,d,parseInt(51+n+10),r),this.topCtx.fillText(this.locale.high,d,parseInt(85+n+10),r),this.topCtx.fillText(this.locale.low,d,parseInt(119+n+10),r),this.topCtx.fillText(this.locale.close,d,parseInt(153+n+10),r),this.topCtx.fillText(this.locale.change,d,parseInt(187+n+10),r),this.topCtx.fillText(this.locale.changer,d,parseInt(221+n+10),r),this.topCtx.fillText(this.locale.executed,d,parseInt(255+n+10),r),this.formateValue(s.volume,this.priceFixed)),d=d+l-22,l=(this.topCtx.textAlign="right",this.topCtx.fillText(o,d,parseInt(17+n+10),p),this.topCtx.fillText(s.open,d,parseInt(51+n+10),p),this.topCtx.fillText(s.high,d,parseInt(85+n+10),p),this.topCtx.fillText(s.low,d,parseInt(119+n+10),p),this.topCtx.fillText(s.close,d,parseInt(153+n+10),p),this.topCtx.fillText(r,d,parseInt(255+n+10),p),this.data.bars[this.curSelectIndex-1]?this.data.bars[this.curSelectIndex-1]:"");let t="n/a",i="n/a";l&&(t=(s.close-l.close).toFixed(this.priceFixed),i=(t/l.close*100).toFixed(2),0<t?(this.topCtx.fillStyle="#03ad8f",t="+"+t,i="+"+i):this.topCtx.fillStyle="#d04b64"),this.topCtx.fillText(t,d,187+n+10,p),this.topCtx.fillText(i+"%",d,221+n+10,p)}this.topCtx.beginPath(),this.topCtx.arc(a,i,5,0,2*Math.PI),this.topCtx.fillStyle="#fff",this.topCtx.fill(),this.topCtx.closePath(),this.topCtx.strokeStyle="#fff",this.topCtx.lineWidth=2;r=this.height-2*this.options.xAxis.offset+4,l=this.topCtx.measureText(o).width+20;this.topCtx.beginPath(),this.topCtx.moveTo(a-.5*l,r),this.topCtx.lineTo(a+.5*l,r),this.topCtx.lineTo(a+.5*l,40+r),this.topCtx.lineTo(a-.5*l,40+r),this.topCtx.lineTo(a-.5*l,r),this.topCtx.stroke(),this.topCtx.fillStyle="#161f2e",this.topCtx.fill(),this.topCtx.closePath(),this.topCtx.fillStyle="#fff",this.topCtx.font="20px Arial",this.topCtx.textAlign="center",this.topCtx.fillText(o,a,25+r,l),this.showCandleMA&&this.chartType===ChartGraph.ChartType.candle&&(d=this.candleMA.getMaWidthIndex(this.visibleRange.from+h),this.drawCandleMAMark(d)),this.showBarMA&&(n=this.barMA.getMaWidthIndex(this.visibleRange.from+h),this.drawBarMAMark(n,s.volume))}}drawCandleMAMark(e){if(this.chartType===ChartGraph.ChartType.candle)if(e&&e.length){this.topCtx.font="20px Arial",this.topCtx.textAlign="left";let i=10;for(let t=0;t<e.length;++t){this.topCtx.fillStyle=e[t].color;var s="MA"+e[t].ma+":"+this.floor(e[t].y,this.priceFixed),h=this.topCtx.measureText(s).width;this.topCtx.fillText(s,i,25,h),i+=h+15}}else if(!e)if(this.data.bars[this.data.bars.length-1]){var a=this.candleMA.getMaWidthIndex(this.data.bars.length-1);this.topCtx.font="20px Arial",this.topCtx.textAlign="left";let i=10;for(let t=0;t<a.length;++t){this.topCtx.fillStyle=a[t].color;var l="MA"+a[t].ma+":"+this.floor(a[t].y,this.priceFixed),o=this.topCtx.measureText(l).width;this.topCtx.fillText(l,i,25,o),i+=o+15}}}drawBarMAMark(e,t){if(e&&e.length){this.topCtx.font="20px Arial",this.topCtx.textAlign="left";var s=this.options.candle.top+this.options.candle.height,t="VOL:"+this.formateValue(t,this.priceFixed),h=this.topCtx.measureText(t).width;this.topCtx.fillText(t,10,s+25,h);let i=h+25;for(let t=0;t<e.length;++t){this.topCtx.fillStyle=e[t].color;var a="MA"+e[t].ma+":"+this.formateValue(e[t].y,this.priceFixed),l=this.topCtx.measureText(a).width;this.topCtx.fillText(a,i,s+25,l),i+=l+15}}else if(!e){t=this.data.bars[this.data.bars.length-1];if(t){var o=this.barMA.getMaWidthIndex(this.data.bars.length-1),n=(this.topCtx.font="20px Arial",this.topCtx.textAlign="left",this.options.candle.top+this.options.candle.height),h="VOL:"+this.formateValue(t.volume,this.priceFixed),t=this.topCtx.measureText(h).width;this.topCtx.fillText(h,10,n+25,t);let i=t+25;for(let t=0;t<o.length;++t){this.topCtx.fillStyle=o[t].color;var r="MA"+o[t].ma+":"+this.formateValue(o[t].y,this.priceFixed),p=this.topCtx.measureText(r).width;this.topCtx.fillText(r,i,n+25,p),i+=p+15}}}}stopMoveAnimation(){this.loopId&&(window.cancelAnimationFrame(this.loopId),this.loopId=null)}startMoveAnimation(){this.moveDis*=12,Math.abs(this.moveDis)<this.minMoveDis||(this.moveSpeed=15,this.stepDis=0,this.loop())}loop(){this.loopId=window.requestAnimationFrame(()=>{this.loopId=null,this.stepDis+=this.moveSpeed,this.moveDis<0?this.moveDis>-this.stepDis?this.updateVisible(1):(this.stepDis>this.barSpacing&&(this.stepDis-=this.barSpacing,this.moveDis+=this.barSpacing,this.updateVisible(1)),this.loop()):0<this.moveDis&&(this.moveDis<this.stepDis?this.updateVisible(-1):(this.stepDis>this.barSpacing&&(this.stepDis-=this.barSpacing,this.moveDis-=this.barSpacing,this.updateVisible(-1)),this.loop()))})}updateVisible(e){if(0<e){let t=this.visibleRange.to+e;var i=this.visibleRange.from+e;i<=this.data.bars.length-this.barNum+this.leftBlank&&(t>this.data.bars.length&&(t=this.data.bars.length),this.visibleRange={from:i,to:t},this.draw())}else if(e<0){let t=this.visibleRange.from+e,i=(t=t<0?0:t)+this.barNum;i>this.data.bars.length&&(i=this.data.bars.length),this.visibleRange={from:t,to:i},this.draw()}}initEvent(){let h=this,s=!1,a=!1,l=null,o=null,n=null,r=!1,p=!1,d=null;this.topCanvas.addEventListener("touchstart",t=>{var i,e;this.stopMoveAnimation(),s||l||1!==t.touches.length?1<t.touches.length&&(l&&(clearTimeout(l),l=null),(d={x0:t.touches[0].pageX,x1:t.touches[1].pageX}).dis=Math.abs(d.x0-d.x1),p=!1):(t=t.touches[0],o=t.pageX,n=t.pageY,i=this.last.getRect(),e=this.el.getBoundingClientRect().top,e=2*(t.pageY-e),i&&i.x0<2*o&&i.x1>2*o&&i.y0<e&&i.y1>e?p=!1:(p=!0,t=parseInt(o/this.barSpacing*2),this.visibleRange.from+t===this.curSelectIndex?a=!0:(a=!1,l=setTimeout(()=>{l=null,a=!0,this.select(o)},300)),s=!0))}),this.topCanvas.addEventListener("touchmove",i=>{var e=i.touches[0],s=Math.abs(n-e.pageY);if(Math.abs(o-e.pageX)<s)l&&(clearTimeout(l),l=null),i.stopPropagation();else{if(i.preventDefault(),d&&1<i.touches.length){let t={x0:i.touches[0].pageX,x1:i.touches[1].pageX};t.dis=Math.abs(t.x0-t.x1);e=Math.abs(d.dis-t.dis);if(e>this.barSpacing){s=parseInt(e/this.barSpacing);if(t.dis<d.dis){if(this.calculateBarNum(this.barNum+s)){let t=this.visibleRange.from,i=t+this.barNum;i>this.data.bars.length&&(i=this.data.bars.length)-t<=this.barNum-this.leftBlank&&(t=i-this.barNum-this.leftBlank),this.visibleRange={from:t,to:i},this.draw()}}else if(this.calculateBarNum(this.barNum-s)){e=this.visibleRange.from;let t=e+this.barNum;t>this.data.bars.length&&(t=this.data.bars.length),this.visibleRange={from:e,to:t},this.draw()}d=t}}if(p)if(l&&(clearTimeout(l),l=null),r||(h.moveDis=0),r=!0,a){s=i.touches[0];h.select(s.pageX)}else{e=i.touches[0];let t=e.pageX-o;if((h.moveDis=t)<0){t=-t;s=parseInt((t/h.barSpacing).toString());if(0<(s+=1)){let t=h.visibleRange.to+s;i=h.visibleRange.from+s;i<=h.data.bars.length-h.barNum+h.leftBlank&&(t>h.data.bars.length&&(t=h.data.bars.length),h.visibleRange={from:i,to:t},h.draw(),o=e.pageX)}}else if(0<t){s=parseInt((t/h.barSpacing).toString());if(0<(s+=1)){let t=h.visibleRange.from-s,i=(t=t<0?0:t)+h.barNum;i>h.data.bars.length&&(i=h.data.bars.length),h.visibleRange={from:t,to:i},h.draw(),o=e.pageX}}}}}),this.topCanvas.addEventListener("touchend",i=>{if(d)d=null;else if(p)l&&(clearTimeout(l),l=null),r?a||this.startMoveAnimation():!a&&this.curSelectIndex?(this.curSelectIndex=null,this.drawTip()):a||this.select(i.changedTouches[0].pageX),s=!1,a=!1,r=!1;else{p=!0;var i=i.changedTouches[0],t=this.el.getBoundingClientRect().top,t=2*(i.pageY-t),e=this.last.getRect();if(i&&e&&e.x0<2*i.pageX&&e.x1>2*i.pageX&&e.y0<t&&e.y1>t){i=this.data.bars.length;let t=this.data.bars.length-this.barNum+this.leftBlank;t=(t=t<0?0:t)>this.data.bars.length?this.data.bars.length-1:t,this.visibleRange={from:t,to:i},void this.draw()}}}),this.topCanvas.addEventListener("touchcancel",function(t){l&&(clearTimeout(l),l=null),s=!1,a=!1,r=!1,p=!0,d=null})}initChart(i){if(this.lastBarItem=i[i.length-1],this.data={bars:i},this.xaisxFormat(),0!==this.data.bars.length){i=this.data.bars.length;let t=this.data.bars.length-this.barNum+this.leftBlank;t=(t=t<0?0:t)>this.data.bars.length?this.data.bars.length-1:t,this.visibleRange={from:t,to:i},this.axis.setData({xAxis:this.options.xAxis,yAxis:this.options.yAxis,width:this.width,height:this.height,xFormat:this.xFormat,candle:this.options.candle,fixed:this.priceFixed}),this.candle.setData({width:this.width,height:this.height,config:this.options.candle}),this.candleMA.setData({bars:this.data.bars,width:this.width,height:this.height,MA:this.options.MA,candle:this.options.candle,fixed:this.priceFixed}),this.bar.setData({width:this.width,height:this.height,config:this.options.bar,candle:this.options.candle,fixed:this.priceFixed}),this.barMA.setData({width:this.width,height:this.height,config:this.options.bar,bars:this.data.bars}),this.last.setData({width:this.width,height:this.height,config:this.options.candle,fixed:this.priceFixed}),this.time.setData({width:this.width,height:this.height,config:this.options.candle,fixed:this.priceFixed}),this.draw()}}drawTip(){this.topCtx.clearRect(0,0,this.width,this.height),this.drawCandleMAMark(),this.drawBarMAMark(),this.curSelectIndex&&this.selectIndex(this.curSelectIndex)}draw(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.drawBackground();let i=1e9,e=0,s=[],h=-100;if(this.chartType===ChartGraph.ChartType.candle){for(let t=this.visibleRange.from;t<this.visibleRange.to;++t){var a=this.data.bars[t];(i=i>parseFloat(a.high)?parseFloat(a.high):i)>parseFloat(a.low)&&(i=parseFloat(a.low)),(e=e<parseFloat(a.high)?parseFloat(a.high):e)<parseFloat(a.low)&&(e=parseFloat(a.low)),h<parseFloat(a.volume)&&(h=parseFloat(a.volume)),s.push(a.time)}this.showCandleMA?this.yRange=this.candleMA.getYRange(this.visibleRange,i,e):this.yRange={min:i,max:e}}else if(this.chartType===ChartGraph.ChartType.time){for(let t=this.visibleRange.from;t<this.visibleRange.to;++t){var l=this.data.bars[t];i>parseFloat(l.close)&&(i=parseFloat(l.close)),e<parseFloat(l.close)&&(e=parseFloat(l.close)),h<parseFloat(l.volume)&&(h=parseFloat(l.volume)),s.push(l.time)}this.showCandleMA?this.yRange=this.candleMA.getYRange(this.visibleRange,0,e):this.yRange={min:0,max:e}}this.showBarMA&&(h=this.barMA.getYRange(this.visibleRange,h)),this.chartType===ChartGraph.ChartType.candle?(this.candle.draw(this.ctx,this.data.bars,this.visibleRange,this.yRange,this.barSpacing),this.showCandleMA&&this.candleMA.draw(this.ctx,this.visibleRange,this.yRange,this.barSpacing)):this.time.draw(this.ctx,this.data.bars,this.visibleRange,this.yRange,this.barSpacing),this.bar.draw(this.ctx,this.data.bars,this.visibleRange,h,this.barSpacing),this.showBarMA&&this.barMA.draw(this.ctx,this.visibleRange,h,this.barSpacing),this.axis.draw(this.ctx,s,this.yRange,this.barNum),this.aniCtx.clearRect(0,0,this.width,this.height),this.last.draw(this.aniCtx,this.lastBarItem,this.visibleRange.to-this.visibleRange.from-1,this.yRange,this.barSpacing,this.chartType===ChartGraph.ChartType.time),this.drawTip()}fetchData(){this.loading(),this.fetch(this.url+this.query(this.request),t=>{this.removeLoading(),t?this.loadData(t):console.log("network error",t)})}loadData(e){if(0!==e.length){let t=[],i=0;for(;i<e.length;++i){var s=e[i],s={time:s[0],open:s[1],high:s[2],low:s[3],close:s[4],volume:s[5]};t.push(s)}this.initChart(t),clearTimeout(this.updateTimerHandler),this.updateTimerHandler=setTimeout(()=>{this.startUpdate()},this.options.updateInterval)}}xaisxFormat(){1==this.request.period?this.xFormat="H:i":this.request.period<1440?this.xFormat="m-d H:i":this.xFormat="y-m-d"}drawBackground(){this.options.background&&this.options.background.forEach(t=>{this.ctx.fillStyle=t.backgroundColor,t.y1?this.ctx.fillRect(0,t.y0,this.canvas.width,t.y1):this.ctx.fillRect(0,t.y0,this.canvas.width,this.height)}),this.ctx.lineWidth=1,this.ctx.strokeStyle="#1a283a";var e=this.options.candle.height/4,i=(this.width-2*this.options.yAxis.offset)/5,s=this.height-2*this.options.xAxis.offset;for(let t=1;t<5;t++){var h=parseInt((t*i).toString());this.drawLine(this.ctx,h,h,0,s)}var a=this.width-this.options.yAxis.offset;for(let i=0;i<5;++i){let t=this.options.candle.top+(4-i)*e;4===i&&(t-=10),this.drawLine(this.ctx,0,a,t,t)}}loading(){this.loadingCanvas||(this.loadingCanvas=new Sonic({width:.5*this.width,height:.5*this.height,stepsPerFrame:3,trailLength:1,pointDistance:.01,fps:30,step:"fader",style:{position:"absolute",left:0,top:0},strokeColor:"#456995",setup:function(){this._.lineWidth=5},path:[["arc",.25*this.width+20,.25*this.height,30,360,0]]}),this.loadingCanvas.play(),this.el.appendChild(this.loadingCanvas.canvas))}removeLoading(){this.loadingCanvas&&(this.el.removeChild(this.loadingCanvas.canvas),delete this.loadingCanvas,this.loadingCanvas=null)}startUpdate(){this.stopUpdate(),this.updateTimerHandler=setTimeout(()=>{this.fetch(this.url+this.query({time:this.lastBarItem.time,channel:this.request.channel,limit:10,period:this.request.period}),t=>{t&&0<t.length&&this.appendItems(t),this.startUpdate()})},2e3)}stopUpdate(){this.updateTimerHandler&&(clearTimeout(this.updateTimerHandler),this.updateTimerHandler=null)}appendItems(i){if(i.length){var t=i[0],t={time:t[0],open:t[1],high:t[2],low:t[3],close:t[4],volume:t[5]};this.data.bars[this.data.bars.length-1]=t;for(let t=1;t<i.length;++t){var e=i[t],e={time:e[0],open:e[1],high:e[2],low:e[3],close:e[4],volume:e[5]};this.data.bars.push(e)}t=this.data.bars[this.data.bars.length-1];(1<i.length||t.time!==this.lastBarItem.time||t.open!==this.lastBarItem.open||t.high!==this.lastBarItem.high||t.low!==this.lastBarItem.low||t.close!==this.lastBarItem.close||t.volume!==this.lastBarItem.volume)&&(this.lastBarItem=t,this.candleMA.updateData(),this.barMA.updateData(),this.visibleRange.to===this.data.bars.length-i.length+1&&(this.visibleRange.from+=i.length-1,this.visibleRange.to+=i.length-1),this.draw())}}showTime(){this.chartType!==ChartGraph.ChartType.time&&(this.chartType=ChartGraph.ChartType.time,this.request.period=1,this.last.stop(),this.stopUpdate(),this.stopMoveAnimation(),this.fetchData())}update(t){t.request&&((t=Object.assign({},this.request,t.request)).period||this.request.period!==t.period||this.request.channel!==t.channel)&&(this.chartType=ChartGraph.ChartType.candle,this.request=t,this.last.stop(),this.stopUpdate(),this.stopMoveAnimation(),this.fetchData())}updateChangeMa(t){this.showCandleMA!==t&&(this.showCandleMA=t,this.chartType===ChartGraph.ChartType.candle&&(this.last.stop(),this.stopUpdate(),this.stopMoveAnimation(),this.draw()))}destroy(){this.stopUpdate(),this.stopMoveAnimation(),this.last.stop()}}ChartGraph.ChartType={time:"time",candle:"candle"};
class RenderAxis extends Render{constructor(){super(),this.size={w:0,h:0},this.fixed=8}setData(t){super.setData(t),this.size.w=this.data.width-2*this.data.yAxis.offset,this.size.h=this.data.height-2*this.data.xAxis.offset,this.fixed=t.fixed||8}draw(e,i,a,s){var t=this.data.xAxis,h=this.data.yAxis,r=this.data.height-2*t.offset;let l=t.mark;e.fillStyle="#666e92",e.font=l.fontSize+" Arial",e.textAlign="center";var n=(this.data.width-2*h.offset)/5,d=(parseInt((i.length/5).toString()),Math.floor(s/5));for(let t=0;t<6;t++){var f=t*d;if(f<i.length){var o=parseInt((t*n).toString()),f=i[f],x=r+l.lineHeight;e.fillText(this.formate(this.data.xFormat,f),o,x+24,120)}else if(t<5||t<6&&i.length===s){f=parseInt((t*n).toString()),o=i[i.length-1],x=r+l.lineHeight;e.fillText(this.formate(this.data.xFormat,o),f,x+24,120);break}}l=h.mark,e.font=l.fontSize+" Arial",e.textAlign="right";var g=this.data.candle.height/4,m=(a.max-a.min)/4;for(let i=0;i<5;++i){let t=this.data.candle.top+(4-i)*g;0===i?t-=12:4===i?t+=8:t-=8;var A=(parseFloat(a.min)+parseFloat((m*i).toString())).toFixed(this.fixed);e.fillText(A,this.data.width-10,t,100)}}}
class RenderLine extends Render{drawBezier(r,t){r.strokeStyle=t.color,r.lineWidth=2,r.beginPath();let y=!1;for(let e=0;e<t.renderItems.length;e++){var n;"-"===t.renderItems[e].y||y?(n=this.getCtrlPoint(t.renderItems,e-1),r.bezierCurveTo(n.pA.x,n.pA.y,n.pB.x,n.pB.y,t.renderItems[e].x,t.renderItems[e].y)):(y=!0,r.moveTo(t.renderItems[e].x,t.renderItems[e].y))}r.stroke()}getCtrlPoint(e,r,t,y){t&&y||(y=t=.25);let n,x,s,d;return x=r<1?(n=e[0].x+(e[1].x-e[0].x)*t,e[0].y+(e[1].y-e[0].y)*t):(n=e[r].x+(e[r+1].x-e[r-1].x)*t,e[r].y+(e[r+1].y-e[r-1].y)*t),d=r>e.length-3?(t=e.length-1,s=e[t].x-(e[t].x-e[t-1].x)*y,e[t].y-(e[t].y-e[t-1].y)*y):(s=e[r+1].x-(e[r+2].x-e[r].x)*y,e[r+1].y-(e[r+2].y-e[r].y)*y),{pA:{x:n,y:x},pB:{x:s,y:d}}}}
class RenderBar extends Render{constructor(){super()}setData(t){super.setData(t),this.height=this.data.config.top+this.data.config.height,this.fixed=t.fixed||8}draw(a,s,h,t,o){var r=this.data.config.height/t,l=parseInt(this.height-1);for(let i=h.from;i<h.to;++i){var n=i-h.from,d=s[i];let t=this.data.config.lowColor,e=0;e=parseFloat(d.open)<=parseFloat(d.close)?(t=this.data.config.highColor,d.open-d.close):d.close-d.open,a.strokeStyle=t;n=parseInt((.5+n)*o),d=parseInt(this.height-d.volume*r);a.lineWidth=o-2,this.drawLine(a,n,n,l,d)}a.fillStyle="#666e92",a.font=this.data.config.yAxis.fontSize+" Arial",a.textAlign="right",a.fillText(this.formateValue(t,this.fixed),this.data.width-10,this.data.candle.top+this.data.candle.height+25,200)}}
class RenderCandle extends Render{constructor(){super()}setData(t){super.setData(t),this.height=this.data.config.top+this.data.config.height}draw(s,o,n,r,l){var t=r.max-r.min,d=this.data.config.height/t;for(let h=n.from;h<n.to;++h){var g=h-n.from,p=o[h];let t=this.data.config.lowColor,e=0;e=parseFloat(p.open)<=parseFloat(p.close)?(t=this.data.config.highColor,p.open-p.close):p.close-p.open,s.strokeStyle=t;var c=parseInt(this.height-(p.high-r.min)*d),f=parseInt(this.height-(p.low-r.min)*d),g=parseInt((.5+g)*l);s.lineWidth=2,this.drawLine(s,g,g,c,f);let i=parseInt(this.height-(p.open-r.min)*d),a=parseInt(this.height-(p.close-r.min)*d);i-a<2&&(--i,a+=1),s.lineWidth=l-2,this.drawLine(s,g,g,i,a)}}}
class RenderCandleMA extends RenderLine{constructor(){super(),this.fixed=8,this.height=0}setData(a){super.setData(a),this.height=this.data.candle.top+this.data.candle.height,this.fixed=a.fixed||8,this.ma=[];for(let e=0;e<a.candle.MA.length;++e){let t=a.candle.MA[e];t.items=this.calculateMA(t.ma,a.bars),this.ma.push(t)}}updateData(){var i=this.ma[0].items.length-1;for(let t=0;t<this.ma.length;++t){let s=this.ma[t];for(let a=i;a<this.data.bars.length;++a)if(a<s.ma)a!==i&&s.items.push("-");else{let e=0;for(let t=0;t<s.ma;t++)e=parseFloat(e)+parseFloat(this.data.bars[a-t].close);a!==i?s.items[a]=parseFloat(parseFloat(e)/parseFloat(s.ma)).toFixed(this.fixed):s.items.push(parseFloat(parseFloat(e)/parseFloat(s.ma)).toFixed(this.fixed))}}}getYRange(a,t,e){let s=parseFloat(t),i=parseFloat(e);for(let e=0;e<this.ma.length;++e)for(let t=a.from;t<a.to;++t){var l=this.ma[e].items[t];"-"!==l&&(l=parseFloat(l),s>l?s=l:i<l&&(i=l))}return{min:parseFloat(s),max:parseFloat(i)}}getMaWidthIndex(e){let a=[];for(let t=0;t<this.ma.length;++t)this.ma[t].items[e]&&"-"!==this.ma[t].items[e]&&a.push({ma:this.ma[t].ma,color:this.ma[t].color,y:this.ma[t].items[e]});return a}draw(e,t,a,s){var i=a.max-a.min,l=this.data.candle.height/i;for(let t=0;t<this.ma.length;++t)this.ma[t].renderItems=[];for(let e=t.from;e<t.to;++e){var r=e-t.from,h=parseInt((.5+r)*s);for(let t=0;t<this.ma.length;++t){var o=this.ma[t].items[e],o=parseInt(this.height-(o-a.min)*l);this.ma[t].renderItems.push({x:h,y:o})}}for(let t=0;t<this.ma.length;++t)this.drawBezier(e,this.ma[t])}calculateMA(s,i){let l=[];for(let a=0,t=i.length;a<t;a++)if(a<s)l.push("-");else{let e=0;for(let t=0;t<s;t++)e=parseFloat(e)+parseFloat(i[a-t].close);l.push(parseFloat(parseFloat(e)/parseFloat(s)).toFixed(this.fixed))}return l}}
class RenderBarMA extends RenderLine{constructor(){super(),this.fixed=8,this.height=0}setData(a){super.setData(a),this.height=this.data.config.top+this.data.config.height,this.fixed=a.fixed||8,this.ma=[];for(let e=0;e<a.config.MA.length;++e){let t=a.config.MA[e];t.items=this.calculateMA(t.ma,a.bars),this.ma.push(t)}}updateData(){var i=this.ma[0].items.length-1;for(let t=0;t<this.ma.length;++t){let s=this.ma[t];for(let a=i;a<this.data.bars.length;++a)if(a<s.ma)a!==i&&s.items.push("-");else{let e=0;for(let t=0;t<s.ma;t++)e=parseFloat(e)+parseFloat(this.data.bars[a-t].volume);a!==i?s.items[a]=parseFloat(parseFloat(e)/parseFloat(s.ma)).toFixed(this.fixed):s.items.push(parseFloat(parseFloat(e)/parseFloat(s.ma)).toFixed(this.fixed))}}}getYRange(a,s){let i=s;for(let e=0;e<this.ma.length;++e)for(let t=a.from;t<a.to;++t){var h=this.ma[e].items[t];"-"!==h&&s<(h=parseFloat(h))&&(i=h)}return i}getMaWidthIndex(e){let a=[];for(let t=0;t<this.ma.length;++t)this.ma[t].items[e]&&"-"!==this.ma[t].items[e]&&a.push({ma:this.ma[t].ma,color:this.ma[t].color,y:this.ma[t].items[e]});return a}draw(e,t,a,s){var i=this.data.config.height/a;for(let t=0;t<this.ma.length;++t)this.ma[t].renderItems=[];for(let e=t.from;e<t.to;++e){var h=e-t.from,r=parseInt((.5+h)*s);for(let t=0;t<this.ma.length;++t){var l=this.ma[t].items[e],l=parseInt(this.height-l*i);this.ma[t].renderItems.push({x:r,y:l})}}for(let t=0;t<this.ma.length;++t)this.drawBezier(e,this.ma[t])}calculateMA(s,i){let h=[];for(let a=0,t=i.length;a<t;a++)if(a<s)h.push("-");else{let e=0;for(let t=0;t<s;t++)e=parseFloat(e)+parseFloat(i[a-t].volume);h.push(parseFloat(parseFloat(e)/parseFloat(s)).toFixed(this.fixed))}return h}}
class RenderLast extends Render{constructor(){super(),this.rect=null,this.point=null}setData(t){super.setData(t),this.height=this.data.config.top+this.data.config.height,this.fixed=t.fixed||8}getRect(){return this.rect}draw(t,i,e,s,a,h){this.point=null,this.stop();e=parseInt((e+.5)*a),a=s.max-s.min,a=this.data.config.height/a;let l=this.height-(i.close-s.min)*a;l=(l=l<this.data.config.top?this.data.config.top:l)>this.height?this.height:l,l=parseInt(l);var n,s=20,a=this.formateValue(i.close+"",this.fixed),o=t.measureText(a).width+10;t.setLineDash([8,8]),t.lineWidth=1,t.fillStyle="#fff",t.strokeStyle="#fff",e>this.data.width-100?(o+=10,this.drawLine(t,0,this.data.width,l,l),t.setLineDash([]),t.lineWidth=2,t.fillStyle="#0d1a27",t.strokeStyle="#4c5d75",n=parseInt(this.data.width-240),this.rect={x0:n-s,y0:l-s,x1:n+o+s,y1:l+s},t.beginPath(),t.moveTo(n,l+s),t.arc(n,l,s,.5*Math.PI,.5*-Math.PI),t.lineTo(n+o,l-s),t.arc(n+o,l,s,.5*-Math.PI,.5*Math.PI),t.lineTo(n,l+s),t.stroke(),t.fill(),t.closePath(),t.fillStyle="#666e92",t.font="18px font_family",t.textAlign="center",t.fillText(a,parseInt(n+.5*o-10),parseInt(l+6),parseInt(o+40)),t.fillStyle="#666e92",t.beginPath(),t.moveTo(parseInt(n+o),l),t.lineTo(parseInt(n+o-10),l+5),t.lineTo(parseInt(n+o-10),l-5),t.lineTo(parseInt(n+o),l),t.stroke(),t.fill(),t.closePath()):(this.rect=null,s=this.formateValue(i.close,this.fixed),this.drawDash(t,e,l,s),h&&(this.point={x:e,y:l,text:s,twin:!0},this.drawDot(t,e,l,25),this.play(t)))}drawDash(t,i,e,s){t.setLineDash([8,8]),t.lineWidth=1,t.fillStyle="#fff",t.strokeStyle="#fff",this.drawLine(t,i,this.data.width-80,e,e),t.setLineDash([]),t.font="18px Arial",t.textAlign="left",t.fillStyle="#0c82df",t.fillText(s,this.data.width-80,e+6,80)}drawDot(t,i,e,s){let a=t.createRadialGradient(i,e,2,i,e,s);a.addColorStop(0,"white"),a.addColorStop(1,"transparent"),t.fillStyle=a,t.fillRect(i-s,e-s,2*s,2*s)}play(t,i=25){this.timer=window.requestAnimationFrame(()=>{this.timer=null,t.clearRect(0,0,this.data.width,this.data.height),this.point.twin?(i-=.5)<15&&(this.point.twin=!1):25<(i+=.5)&&(this.point.twin=!0),this.drawDash(t,this.point.x,this.point.y,this.point.text),this.drawDot(t,this.point.x,this.point.y,i),this.play(t,i)})}stop(){this.timer&&(window.cancelAnimationFrame(this.timer),this.timer=null)}}
class RenderTime extends RenderLine{constructor(){super()}setData(t){super.setData(t),this.height=this.data.config.top+this.data.config.height}draw(e,i,r,h,o){var a,t=h.max-h.min,s=this.data.config.height/t;let l=[];for(let t=r.from;t<r.to;++t){var n=t-r.from,d=i[t],d=this.height-(d.low-h.min)*s;l.push({x:n*o,y:d})}e.lineWidth=2,e.strokeStyle="#393bff",this.drawBezier(e,{renderItems:l}),e.lineWidth=2,e.strokeStyle="transparent",e.beginPath(),e.moveTo(0,this.height);for(let t=0;t<l.length;t++)0===t?e.lineTo(l[t].x,l[t].y):(a=this.getCtrlPoint(l,t-1),e.bezierCurveTo(a.pA.x,a.pA.y,a.pB.x,a.pB.y,l[t].x,l[t].y)),t===l.length-1&&e.lineTo(l[t].x,this.height);e.stroke();let g=e.createLinearGradient(0,0,0,this.height);g.addColorStop(0,"rgba(0,0,255,0.3)"),g.addColorStop(.4,"rgba(0,0,255,0.01)"),e.fillStyle=g,e.fill(),e.closePath()}}
let depth_theme_white={backgroundColor:"white",buy:{lineColor:"#5baa7f",fillColor:"rgba(91,170,120,0.2)",lineWidth:4,mark:{circleColor:"#5baa7f",circleStrokeColor:"rgba(91,170,127,0.3)",lineColor:"#2fdb98",tipsBackgroundColor:"rgba(0,0,0,0.5)",textColor:"#fff",fontSize:"24px",poleColor:"#5baa7f"}},sell:{lineColor:"#d74e5a",fillColor:"rgba(215,78,90,0.2)",lineWidth:4,mark:{circleColor:"#d74e5a",circleStrokeColor:"rgba(215,78,90,0.3)",lineColor:"#b71e29",tipsBackgroundColor:"rgba(0,0,0,0.5)",textColor:"#fff",fontSize:"24px",poleColor:"#d74e5a"}}},depth_theme_blue023={backgroundColor:"#181729",buy:{lineColor:"#5baa7f",fillColor:"#223740",lineWidth:8,mark:{circleColor:"#5baa7f",circleStrokeColor:"rgba(47,219,152,0.5)",lineColor:"#2fdb98",tipsBackgroundColor:"rgba(0,0,0,0.5)",textColor:"#fff",fontSize:"24px",poleColor:"#5baa7f"}},sell:{lineColor:"#d74e5a",fillColor:"#442738",lineWidth:8,mark:{circleColor:"#d74e5a",circleStrokeColor:"rgba(255, 0, 0, 0.2)",lineColor:"#b71e29",tipsBackgroundColor:"rgba(0,0,0,0.5)",textColor:"#fff",fontSize:"24px",poleColor:"#d74e5a"}}};class DepthChart extends RenderLine{constructor(t){super();this.options=Object.assign({url:"",request:{channel:"",limit:60},el:"",backgroundColor:"#181729",updateInterval:3e4,xAxis:{width:1,color:"#484e67",offset:30,position:"bottom",mark:{textColor:"#666e92",fontSize:"24px",lineColor:"#4e5570",lineHeight:10,lineWidth:1,fixed:4}},yAxis:{width:1,color:"#666e92",top:20,position:"right",mark:{textColor:"#666e92",fontSize:"22px",lineColor:"#4e5570",lineHeight:10,lineWidth:1,fixed:4}},buy:{lineColor:"#5baa7f",fillColor:"#223740",lineWidth:2,mark:{circleColor:"#5baa7f",circleStrokeColor:"rgba(47,219,152,0.5)",lineColor:"#2fdb98",tipsBackgroundColor:"rgba(0,0,0,0.5)",textColor:"#fff",fontSize:"24px",poleColor:"#5baa7f"}},sell:{lineColor:"#d74e5a",fillColor:"#442738",lineWidth:2,mark:{circleColor:"#d74e5a",circleStrokeColor:"rgba(255, 0, 0, 0.2)",lineColor:"#b71e29",tipsBackgroundColor:"rgba(0,0,0,0.5)",textColor:"#fff",fontSize:"24px",poleColor:"#d74e5a"}}},t),this.request=this.options.request,"white"===t.theme&&(this.options=Object.assign(this.options,depth_theme_white)),this.el=this.options.el,this.url=t.url,this.el.style.position="relative",this.width=this.el.style.width||this.el.clientWidth,this.height=this.el.style.height?this.el.style.width:this.el.clientHeight,this.width*=2,this.height*=2,this.chartHeight=this.height-2*this.options.xAxis.offset-2*this.options.yAxis.top,this.canvas=this.createDom(),this.ctx=this.canvas.getContext("2d"),this.ctx.translate(.5,.5),this.el.appendChild(this.canvas),this.drawBackground(),this.loading(),this.topCanvas=this.createDom(),this.topCtx=this.topCanvas.getContext("2d"),this.topCtx.translate(.5,.5),this.el.appendChild(this.topCanvas),this.fetchData(),this.initEvent()}initEvent(){let e=!(this.curIdx=-1),s=!1,o=null,h=null;this.topCanvas.addEventListener("touchstart",t=>{s=!1,e=!1;let i=t.touches[0].pageX;o=i,h=t.touches[0].pageY,this.longTimerHandler&&(clearTimeout(this.longTimerHandler),this.longTimerHandler=null),this.longTimerHandler=setTimeout(()=>{this.longTimerHandler=null,this.onTouch(i),e=!0},300)}),this.topCanvas.addEventListener("touchmove",t=>{var i=t.touches[0],e=Math.abs(h-i.pageY);Math.abs(o-i.pageX)<e?(this.longTimerHandler&&(clearTimeout(this.longTimerHandler),this.longTimerHandler=null),t.stopPropagation()):(t.preventDefault(),this.longTimerHandler&&(clearTimeout(this.longTimerHandler),this.longTimerHandler=null),this.data&&(s=!0,i=t.touches[0].pageX,this.onTouch(i)))}),this.topCanvas.addEventListener("touchend",t=>{this.longTimerHandler&&(clearTimeout(this.longTimerHandler),this.longTimerHandler=null),s||e||this.topCtx.clearRect(0,0,this.width,this.width),s=!1,e=!1})}onTouch(i){if((i*=2)<=this.data.asks[0].x){let t=this.data.bids.findIndex(function(t){return t.x>=i});-1!==t?(0<t&&(t=i-this.data.bids[t-1].x>this.data.bids[t].x-i?t:t-1),this.curIdx!==t&&(this.curIdx=t,e=this.data.bids[t],this.drawPoint(e,this.options.buy))):(this.curIdx=-1,this.topCtx.clearRect(0,0,this.width,this.height))}else if(i>=this.data.asks[0].x){let t=this.data.asks.findIndex(function(t){return t.x>=i});var e;-1!==t?(0<t&&(t=i-this.data.asks[t-1].x>this.data.asks[t].x-i?t:t-1),this.curIdx!==t&&(this.curIdx=t,e=this.data.asks[t],this.drawPoint(e,this.options.sell))):(this.curIdx=-1,this.topCtx.clearRect(0,0,this.width,this.width))}}drawPoint(t,i){this.topCtx.clearRect(0,0,this.width,this.width),this.topCtx.lineWidth=2,this.topCtx.strokeStyle=i.mark.lineColor,this.topCtx.beginPath(),this.topCtx.setLineDash([10]),this.topCtx.moveTo(t.x,this.height-2*this.options.xAxis.offset),this.topCtx.lineTo(t.x,t.y),this.topCtx.stroke(),this.topCtx.closePath(),this.topCtx.save(),this.topCtx.setLineDash([]),this.topCtx.lineWidth=16,this.topCtx.beginPath(),this.topCtx.arc(t.x,t.y,10,2*Math.PI,0,!1),this.topCtx.fillStyle=i.mark.circleColor,this.topCtx.strokeStyle=i.mark.circleStrokeColor,this.topCtx.fill(),this.topCtx.stroke(),this.topCtx.closePath(),this.topCtx.save(),this.topCtx.textAlign="center",this.topCtx.font="24px Arial";var e=this.topCtx.measureText(t.price).width+20,s=(this.topCtx.setLineDash([]),this.topCtx.strokeStyle=i.mark.lineColor,this.topCtx.fillStyle="#181728",this.topCtx.lineWidth=4,this.topCtx.beginPath(),this.topCtx.moveTo(t.x-.5*e,this.height-2*this.options.xAxis.offset),this.topCtx.lineTo(t.x+.5*e,this.height-2*this.options.xAxis.offset),this.topCtx.lineTo(t.x+.5*e,this.height-2*this.options.xAxis.offset+32),this.topCtx.lineTo(t.x-.5*e,this.height-2*this.options.xAxis.offset+32),this.topCtx.lineTo(t.x-.5*e,this.height-2*this.options.xAxis.offset),this.topCtx.stroke(),this.topCtx.fill(),this.topCtx.closePath(),this.topCtx.fillStyle=i.mark.lineColor,this.topCtx.fillText(t.price,t.x,this.height-2*this.options.xAxis.offset+24,e),this.formateValue(t.total,this.options.yAxis.mark.fixed)),e=this.topCtx.measureText(s).width+20;this.topCtx.strokeStyle=i.mark.lineColor,this.topCtx.fillStyle="#181728",this.topCtx.lineWidth=4,this.topCtx.beginPath(),this.topCtx.moveTo(this.width-e,t.y+16),this.topCtx.lineTo(this.width-4,t.y+16),this.topCtx.lineTo(this.width-4,t.y-16),this.topCtx.lineTo(this.width-e,t.y-16),this.topCtx.lineTo(this.width-e,t.y+16),this.topCtx.stroke(),this.topCtx.fill(),this.topCtx.closePath(),this.topCtx.fillStyle=i.mark.lineColor,this.topCtx.fillText(s,this.width-.5*e,t.y+8,e)}changeTheme(t){this.options.theme=t,this.options="white"===t?Object.assign(this.options,depth_theme_white):Object.assign(this.options,depth_theme_blue023),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.drawBackground(),this.initChart()}update(t){this.request.channel!==t&&(this.stopUpdate(),this.request.channel=t,this.loading(),this.fetchData())}startUpdate(){this.stopUpdate(),clearTimeout(this.updateTimerHandler),this.updateTimerHandler=setTimeout(()=>{this.updateTimerHandler=null,this.fetchData()},this.options.updateInterval)}stopUpdate(){this.updateTimerHandler&&(clearTimeout(this.updateTimerHandler),this.updateTimerHandler=null)}destroy(){this.stopUpdate(),this.longTimerHandler&&(clearTimeout(this.longTimerHandler),this.longTimerHandler=null)}initChart(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.drawBackground(),this.draw()}drawBuyMain(){let t=this.data.bids;var i=this.height-2*this.options.xAxis.offset,e=(i-2*this.options.yAxis.top)/this.data.yRange.max,s=this.width/(this.data.xRange.max-this.data.xRange.min);this.ctx.strokeStyle=this.options.buy.lineColor,this.ctx.lineWidth=2*this.options.buy.lineWidth,this.ctx.beginPath(),this.ctx.moveTo(0,i);let o=0;for(;o<t.length;++o){var h=t[o];t[o].x=parseInt((h.price-this.data.xRange.min)*s),t[o].y=parseInt(i-h.total*e),this.ctx.lineTo(t[o].x,t[o].y)}this.ctx.lineTo(t[o-1].x,i),this.ctx.stroke(),this.ctx.fillStyle=this.options.buy.fillColor,this.ctx.fill(),this.ctx.closePath()}drawSellMain(){let i=this.data.asks;var e=this.height-2*this.options.xAxis.offset,s=(e-2*this.options.yAxis.top)/this.data.yRange.max,o=this.width/(this.data.xRange.max-this.data.xRange.min);this.ctx.strokeStyle=this.options.sell.lineColor,this.ctx.lineWidth=2*this.options.sell.lineWidth,this.ctx.beginPath(),i[0].x=(i[0].price-this.data.xRange.min)*o,i[0].y=e-i[0].total*s,this.ctx.moveTo(i[0].x,e);for(let t=0;t<i.length;++t){var h=i[t];i[t].x=parseInt((h.price-this.data.xRange.min)*o),i[t].y=parseInt(e-h.total*s),this.ctx.lineTo(i[t].x,i[t].y)}this.ctx.lineTo(this.width,e),this.ctx.stroke(),this.ctx.fillStyle=this.options.sell.fillColor,this.ctx.fill(),this.ctx.closePath()}draw(){this.data&&(this.drawBuyMain(),this.drawSellMain(),this.drawAxis()),this.drawMark()}drawMark(){this.ctx.fillStyle=this.options.buy.lineColor,this.ctx.fillRect(.5*this.width-50,40,16,16),this.ctx.fillStyle="#6d6282",this.ctx.textAlign="left",this.ctx.fillText("买盘",.5*this.width-26,56,100),this.ctx.fillStyle=this.options.sell.lineColor,this.ctx.fillRect(.5*this.width+50,40,16,16),this.ctx.fillStyle="#6d6282",this.ctx.textAlign="left",this.ctx.fillText("卖盘",.5*this.width+76,56,100)}drawAxis(){var t=this.options.yAxis;this.ctx.lineWidth=2*t.width,this.ctx.strokeStyle=t.color,this.drawYLabel(),this.drawXLabel()}drawXLabel(){var t=this.options.xAxis.mark,i=this.data.xRange.max-this.data.xRange.min,i=this.width/i,i=parseInt((this.data.xRange.mid-this.data.xRange.min)*i),e=parseInt(this.height-2*this.options.xAxis.offset+30);this.ctx.fillStyle=t.textColor,this.ctx.font=t.fontSize+" Arial",this.ctx.textAlign="center",this.ctx.fillText(this.formateValue(this.data.xRange.mid,t.fixed),i,e,120),this.ctx.textAlign="left",this.ctx.fillText(this.formateValue(this.data.xRange.min,t.fixed),15,e,120),this.ctx.textAlign="right",this.ctx.fillText(this.formateValue(this.data.xRange.max,t.fixed),this.width-15,e,120)}drawYLabel(){var i=this.options.yAxis.mark,e=this.height-2*this.options.xAxis.offset,s=(e-2*this.options.yAxis.top)/5;this.ctx.lineWidth=2*i.lineWidth,this.ctx.strokeStyle=i.lineColor,this.ctx.fillStyle=i.textColor,this.ctx.font=i.fontSize+" Arial",this.ctx.textAlign="right";for(let t=0;t<5;++t){var o=this.data.yRange.max*(t+1)/5;this.ctx.fillText(this.formateValue(o,i.fixed),this.width-15,parseInt(e-s*(t+1)),100)}}drawBackground(){this.options.backgroundColor&&(this.ctx.fillStyle=this.options.backgroundColor,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.save())}loading(){this.loadingCanvas||(this.loadingCanvas=new Sonic({width:.5*this.width,height:.5*this.height,stepsPerFrame:3,trailLength:1,pointDistance:.01,fps:30,step:"fader",style:{position:"absolute",left:0,top:0},strokeColor:"#456995",setup:function(){this._.lineWidth=5},path:[["arc",.25*this.width+20,.25*this.height,30,360,0]]}),this.loadingCanvas.play(),this.el.appendChild(this.loadingCanvas.canvas))}fetchData(){this.fetch(this.url+this.query(this.request),t=>{if(this.removeLoading(),t){let s=t.bids,o=t.asks;if(s.length<5||s.length<5)this.data=null,this.initChart();else{s.sort(function(t,i){return parseFloat(t.price)>parseFloat(i.price)?1:-1}),o.sort(function(t,i){return parseFloat(t.price)>parseFloat(i.price)?1:-1});let i=parseFloat(s[0].total),e=parseFloat(s[0].total);for(let t=0;t<s.length;++t){var h=parseFloat(s[t].total);h>e?e=h:h<i&&(i=h)}for(let t=0;t<o.length;++t){var l=parseFloat(o[t].total);l>e?e=l:l<i&&(i=l)}this.data={bids:s,asks:o,xRange:{min:parseFloat(s[0].price),max:parseFloat(o[o.length-1].price),mid:.5*(parseFloat(s[s.length-1].price)+parseFloat(o[0].price))},yRange:{min:parseFloat(i),max:parseFloat(e).toFixed(8)}},this.initChart(),this.startUpdate()}}})}removeLoading(){this.loadingCanvas&&(this.el.removeChild(this.loadingCanvas.canvas),delete this.loadingCanvas,this.loadingCanvas=null)}}